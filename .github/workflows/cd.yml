name: CD - Auto Tag & Release

on:
  push:
    branches:
      - development
    paths: [ 'src/**', 'build.gradle', 'settings.gradle' ]
    paths-ignore:
      - '.github/workflows/**'
    tags-ignore:
      - '*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # JDK ì„¤ì •
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # Gradle ë¹Œë“œ
      - name: Build project
        run: ./gradlew clean build --stacktrace

      # GitHub API í˜¸ì¶œìš©
      - name: Ensure GitHub CLI installed
        run: |
          if ! command -v gh &> /dev/null; then
            sudo apt update && sudo apt install gh -y
          fi

      # ìµœì‹  PR ì œëª© ê¸°ë°˜ ë²„ì „ ê³„ì‚°
      - name: Determine next version (Based on PR title)
        id: version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git fetch --tags
          
          # ê¸°ì¡´ ìµœì‹  íƒœê·¸ í™•ì¸
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          echo "Latest tag: $latest_tag"

          # ìµœê·¼ merge ì»¤ë°‹ ë©”ì‹œì§€ì˜ ì²« ì¤„ì„ PR ì œëª©ìœ¼ë¡œ ì¸ì‹
          pr_title=$(git log -1 --pretty=%B | head -n 1 | tr '[:upper:]' '[:lower:]')
          
          echo "PR title: $pr_title"
          echo "pr_title=$pr_title" >> $GITHUB_OUTPUT
          
          # íƒœê·¸ ìˆ«ì ë¶„ë¦¬
          IFS='.' read -r major minor patch <<<"${latest_tag#v}"

          # ë²„ì „ ê·œì¹™ ì ìš© (:gitmoji: type: desc)
          if echo "$pr_title" | grep -Eq '^:[a-z0-9_+]+:\s*(hotfix|fix)\s*:\s*.+'; then
            new_tag="v$major.$minor.$((patch+1))"
          elif echo "$pr_title" | grep -Eq '^:[a-z0-9_+]+:\s*(feature|feat)\s*:\s*.+'; then
            new_tag="v$major.$((minor+1)).0"
          elif echo "$pr_title" | grep -Eq '^:[a-z0-9_+]+:\s*(release|major)\s*:\s*.+'; then
            new_tag="v$((major+1)).0.0"
          else
            new_tag="v$major.$minor.$((patch+1))"
          fi

          echo "New tag: $new_tag"
          echo "tag=$new_tag" >> $GITHUB_OUTPUT

      # íƒœê·¸ ìƒì„± ë° í‘¸ì‹œ
      - name: Create Git Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}

      # ë¦´ë¦¬ìŠ¤ ë³¸ë¬¸ì— ì»¤ë°‹ ë¡œê·¸ í¬í•¨
      - name: Generate commit log
        id: changelog
        run: |
          # ìµœì‹  íƒœê·¸ ëª©ë¡ ì •ë ¬ (ì‘ì„± ìˆœì„œ ê¸°ì¤€)
          all_tags=($(git tag --sort=creatordate))
          current_tag=${{ steps.version.outputs.tag }}
          previous_tag=""

          # í˜„ì¬ íƒœê·¸ ì´ì „ì˜ íƒœê·¸ ì°¾ê¸°
          for ((i=${#all_tags[@]}-1; i>=0; i--)); do
            if [[ "${all_tags[$i]}" == "$current_tag" && $i -gt 0 ]]; then
              previous_tag=${all_tags[$((i-1))]}
              break
            fi
          done

          if [ -z "$previous_tag" ]; then
            echo "âš ï¸ No previous tag found. Using initial commits."
            changelog=$(git log --pretty=format:"- %s")
          else
            echo "Previous tag found: $previous_tag"
            changelog=$(git log ${previous_tag}..HEAD --pretty=format:"- %s")
          fi

          # Slackê³¼ Releaseìš© ì¶œë ¥
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$changelog" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # GitHub Release ìë™ ìƒì„±
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "TEAM-3 Release ${{ steps.version.outputs.tag }}"
          body: |
            **ìë™ ë¦´ë¦¬ìŠ¤ ìƒì„±**
            - Branch: `${{ github.ref_name }}`
            - Commit: `${{ github.sha }}`
            - Author: `${{ github.actor }}`
            - PR Title: `${{ steps.version.outputs.pr_title }}`

            ### í¬í•¨ëœ ì»¤ë°‹ ë‚´ì—­
            ${{ steps.changelog.outputs.changelog }}
          files: |
            build/libs/*.jar
          prerelease: ${{ startsWith(steps.version.outputs.tag, 'v1.') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Slack ì•Œë¦¼ (ë¦´ë¦¬ìŠ¤ ì™„ë£Œ í›„ì—ë§Œ)
      - name: Notify Slack of Release
        if: success()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"text\": \":rocket: *TEAM-3 Release Completed!*\",
            \"attachments\": [
              {
                \"color\": \"#36a64f\",
                \"title\": \"Release ${{ steps.version.outputs.tag }}\",
                \"title_link\": \"https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}\",
                \"text\": \"ğŸ¯ *Latest Version:* \`${{ steps.version.outputs.tag }}\`\nğŸ“ *PR Title:* \`${{ steps.version.outputs.pr_title }}\`\n\në¦´ë¦¬ìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\"
              }
            ]
          }" \
          ${{ secrets.SLACK_WEBHOOK_URL }}
