name: CI - PR Validation & Build Pipeline

on:
  pull_request:
    branches:
      - development
      - release/*
    types: [opened, edited, synchronize, reopened]

permissions:
  actions: read
  contents: read
  checks: write
  pull-requests: write

jobs:
  # -----------------------------------------------------
  # 1) 공통 Title Check
  # -----------------------------------------------------
  title-check:
    name: Validate PR Title
    runs-on: ubuntu-latest

    steps:
      - name: Validate PR title format
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title;
            const regex = /^:[a-z0-9_+]+:\s*(hotfix|fix|feature|feat|major|release)\s*:\s*.+/;

            if (!regex.test(title)) {
              core.setFailed(`❌ Invalid PR title format: "${title}"

              Expected format:
                :gitmoji: type: description
                :gitmoji:type: description

              Allowed types:
                hotfix | fix | feature | feat | major | release`);
            }

  # -----------------------------------------------------
  # 2) FULL CI — feature → release/*
  # -----------------------------------------------------
  full-ci:
    name: FULL CI (Build + Test + Coverage + PMD + SpotBugs)
    needs: title-check
    runs-on: ubuntu-latest

    if: |
      startsWith(github.event.pull_request.head.ref, 'feature/') &&
      startsWith(github.event.pull_request.base.ref, 'release/')

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 21 (Temurin)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build & Test (FULL)
        run: ./gradlew clean build --stacktrace --no-build-cache

      - name: Generate Coverage
        run: ./gradlew jacocoTestReport

      - name: Upload PMD Report
        uses: actions/upload-artifact@v4
        with:
          name: PMD-Report
          path: build/reports/pmd/pmd-report.html

      - name: Upload SpotBugs Report
        uses: actions/upload-artifact@v4
        with:
          name: SpotBugs-Report
          path: build/reports/spotbugs/spotbugs-report.html

      - name: Upload JaCoCo HTML Report
        uses: actions/upload-artifact@v4
        with:
          name: JaCoCo-Report
          path: build/reports/jacoco/test/

      - name: Slack Notify (FULL)
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,commit,author,ref
          text: |
            *TEAM-3 FULL CI Results*
            Status: `${{ job.status }}`
            Source Branch: `${{ github.event.pull_request.head.ref }}`
            Target Branch: `${{ github.event.pull_request.base.ref }}`
            Title: `${{ github.event.pull_request.title }}`
            Coverage, PMD, SpotBugs artifacts uploaded.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # -----------------------------------------------------
  # 3) LIGHT CI — release/* → development
  # -----------------------------------------------------
  light-ci:
    name: LIGHT CI (Build Only)
    needs: title-check
    runs-on: ubuntu-latest

    if: |
      startsWith(github.event.pull_request.head.ref, 'release/') &&
      github.event.pull_request.base.ref == 'development'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build Only
        run: ./gradlew clean assemble --stacktrace

      - name: Slack Notify (Light)
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,commit,author,ref
          text: |
            *TEAM-3 LIGHT CI Results*
            Status: `${{ job.status }}`
            Source Branch: `${{ github.event.pull_request.head.ref }}`
            Target Branch: `${{ github.event.pull_request.base.ref }}`
            Build-only pipeline completed.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # -----------------------------------------------------
  # 4) MEDIUM CI — hotfix → development
  # -----------------------------------------------------
  medium-ci:
    name: MEDIUM CI (Build + Test)
    needs: title-check
    runs-on: ubuntu-latest

    if: |
      startsWith(github.event.pull_request.head.ref, 'hotfix/') &&
      github.event.pull_request.base.ref == 'development'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build & Test (Medium Level)
        run: ./gradlew clean test --stacktrace

      - name: Slack Notify (Medium)
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,commit,author,ref
          text: |
            *TEAM-3 MEDIUM CI Results*
            Status: `${{ job.status }}`
            Source Branch: `${{ github.event.pull_request.head.ref }}`
            Target Branch: `${{ github.event.pull_request.base.ref }}`
            Test-only pipeline completed.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}