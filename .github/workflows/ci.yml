name: Title Check + CI - Build & Test + Slack Notify

on:
  pull_request_target:
    branches:
      - development
    types: [opened, edited, synchronize, reopened]

permissions:
  actions: read
  contents: read

jobs:
  title-check:
    name: Validate PR Title
    runs-on: ubuntu-latest

    steps:
      - name: Validate PR title format
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title;
            const regex = /^:[a-z0-9_+]+:\s*(hotfix|fix|feature|feat|major|release)\s*:\s*.+/;

            if (!regex.test(title)) {
              core.setFailed(`β Invalid PR title format: "${title}"

              Expected format:
                :gitmoji: type: description
                :gitmoji:type: description
            
              Allowed types:
                hotfix | fix | feature | feat | major | release
            
              Examples:
                :sparkles: feat: add hover effect
                :bug: fix: prevent null pointer exception
                :ambulance: hotfix: resolve crash when paused
                :rocket: release: v1.0.0 stable build
                :boom: major: refactor game engine
                :tada: feature: achievement system added`);
            }

  build-test:
    name: Build, Test, and Notify
    needs: title-check
    if: success()
    runs-on: ubuntu-latest

    steps:
      # μ½”λ“ μ²΄ν¬μ•„μ›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      # JDK ν™κ²½ μ„Έν…
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # Build + Unit Test μ‹¤ν–‰
      - name: Build and Run Tests
        run: ./gradlew clean build test --stacktrace --no-build-cache

      # PMD μ‹¤ν–‰ (λ¶ν•„μ”ν• μ½”λ“ μ²΄ν¬)
      - name: Run PMD Analysis (Build Gate)
        run: ./gradlew pmdMain --stacktrace

      # PMD Report Upload
      - name: Upload PMD Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: PMD-Report
          path: build/reports/pmd/pmd-report.html

      # Spotbugs μ‹¤ν–‰ (ν’μ§ κ²μ΄νΈ)
      - name: Run SpotBugs (Build Gate)
        run: ./gradlew spotbugsMain --stacktrace --rerun-tasks

      - name: Upload SpotBugs Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: SpotBugs-Report
          path: build/reports/spotbugs/spotbugs-report.html

      # Slack μ•λ¦Ό μ „μ†΅ (λΉλ“ κ²€μ‚¬))
      - name: Send Slack Notification (Detailed)
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,commit,author,ref,workflow
          text: |
            *TEAM-3 CI Results*
            Status: `${{ job.status }}`
            Author: `${{ github.actor }}`
            Branch: `${{ github.ref_name }}`
            
            *Pull Request Info*
            Title: `${{ github.event.pull_request.title }}`
            Source Branch: `${{ github.event.pull_request.head.ref }}`

            β€Ά Pmd Reports & SpotBugs Reports available in Artifacts.
            β€Ά Details π‘‰ ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
